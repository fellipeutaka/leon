# Migrations — Drizzle Kit

## Table of Contents
- [drizzle.config.ts](#drizzleconfigts)
- [Commands](#commands)
- [Custom Migrations](#custom-migrations)
- [Programmatic Migration](#programmatic-migration)
- [Team Workflow](#team-workflow)

## drizzle.config.ts

```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  // Required
  dialect: "postgresql",                     // "postgresql" | "mysql" | "sqlite" | "turso" | "singlestore"
  schema: "./src/db/schema.ts",              // path to schema file(s), supports glob: "./src/**/*.schema.ts"

  // Output
  out: "./drizzle",                          // migration output directory (default: "./drizzle")

  // Database connection
  dbCredentials: {
    url: process.env.DATABASE_URL!,          // connection string
    // OR individual params (PG):
    // host: "localhost", port: 5432, user: "postgres", password: "...", database: "mydb", ssl: true
    // OR Turso:
    // url: process.env.TURSO_URL!, authToken: process.env.TURSO_AUTH_TOKEN
    // OR D1:
    // wranglerConfigPath: "./wrangler.toml", dbName: "my-d1-db"
  },

  // Filtering
  tablesFilter: ["*"],                       // glob pattern(s) for table names: ["users", "posts"] or "user*"
  schemaFilter: ["public"],                  // which DB schemas to manage (PG/MSSQL)
  extensionsFilters: ["postgis"],            // extensions to acknowledge (prevents managing their internal tables)

  // Migration options
  migrations: {
    table: "__drizzle_migrations",           // custom migrations journal table name
    schema: "public",                        // schema for migrations table (PG)
  },

  // Behavior
  breakpoints: true,                         // add SQL breakpoint comments (default: true)
  strict: false,                             // always ask for confirmation on push (default: false)
  verbose: false,                            // print all SQL statements during push (default: false)

  // Introspection
  introspect: {
    casing: "camel",                         // "camel" | "preserve" — column name casing in generated schema
  },

  // Entities
  entities: {
    roles: {
      provider: "",                          // "neon" | "supabase" | "" — for managed roles
      include: ["admin"],                    // whitelist roles
      exclude: ["pg_*"],                     // blacklist roles
    },
  },

  // Casing
  casing: "snake_case",                      // auto-map camelCase TS keys to snake_case DB columns
});
```

## Commands

### generate

Create SQL migration files from schema diff:

```bash
npx drizzle-kit generate
npx drizzle-kit generate --name "add_users_table"   # custom migration name
npx drizzle-kit generate --custom                    # empty migration file for manual SQL
```

Output structure:
```
drizzle/
├── 0000_add_users_table.sql
├── 0001_another_change.sql
└── meta/
    ├── 0000_snapshot.json
    ├── 0001_snapshot.json
    └── _journal.json
```

### migrate

Apply pending migrations to the database:

```bash
npx drizzle-kit migrate
```

Reads migrations from `out` directory, tracks applied migrations in journal table.

### push

Sync schema directly to database without migration files (good for prototyping):

```bash
npx drizzle-kit push
```

- Compares current schema to live DB and applies diff
- No migration files generated
- Good for local dev / rapid prototyping
- **Not recommended for production** — use generate + migrate instead

### pull (Introspect)

Generate Drizzle schema from existing database:

```bash
npx drizzle-kit pull
```

- Reads DB structure and outputs TypeScript schema files
- Useful for adopting Drizzle in existing projects
- Output goes to `out` directory

### check

Validate migration history consistency:

```bash
npx drizzle-kit check
```

- Detects conflicting migrations (e.g., from different branches)
- Reports hash mismatches in snapshots
- Essential for team workflows

### up

Upgrade migration snapshots to latest format:

```bash
npx drizzle-kit up
```

Run after updating drizzle-kit to ensure snapshot compatibility.

### studio

Launch visual database browser:

```bash
npx drizzle-kit studio
npx drizzle-kit studio --port 4983
```

Opens web UI at https://local.drizzle.studio for browsing/editing data.

## Custom Migrations

Add manual SQL to generated migration files:

```sql
-- Generated by drizzle-kit
CREATE TABLE "users" (
  "id" SERIAL PRIMARY KEY,
  "name" TEXT
);

-- Custom: seed initial data
INSERT INTO "users" ("name") VALUES ('admin');

-- Custom: create extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

Generate an empty migration for fully custom SQL:

```bash
npx drizzle-kit generate --custom
```

## Programmatic Migration

Apply migrations in application code (useful for serverless, CI/CD):

### PostgreSQL (node-postgres)

```ts
import { drizzle } from "drizzle-orm/node-postgres";
import { migrate } from "drizzle-orm/node-postgres/migrator";

const db = drizzle(process.env.DATABASE_URL!);

await migrate(db, { migrationsFolder: "./drizzle" });
```

### MySQL (mysql2)

```ts
import { drizzle } from "drizzle-orm/mysql2";
import { migrate } from "drizzle-orm/mysql2/migrator";

const db = drizzle(process.env.DATABASE_URL!);

await migrate(db, { migrationsFolder: "./drizzle" });
```

### SQLite (better-sqlite3)

```ts
import { drizzle } from "drizzle-orm/better-sqlite3";
import { migrate } from "drizzle-orm/better-sqlite3/migrator";

const db = drizzle("sqlite.db");

migrate(db, { migrationsFolder: "./drizzle" });
```

### Turso / LibSQL

```ts
import { drizzle } from "drizzle-orm/libsql";
import { migrate } from "drizzle-orm/libsql/migrator";

const db = drizzle({
  connection: { url: process.env.TURSO_URL!, authToken: process.env.TURSO_AUTH_TOKEN },
});

await migrate(db, { migrationsFolder: "./drizzle" });
```

### Migration Options

```ts
await migrate(db, {
  migrationsFolder: "./drizzle",
  migrationsTable: "__drizzle_migrations",    // custom table name
  migrationsSchema: "drizzle",                // custom schema (PG only)
});
```

## Team Workflow

### Handling Branch Conflicts

When multiple developers modify schema on different branches:

1. Each developer runs `npx drizzle-kit generate` on their branch
2. On merge, migration files may conflict (same sequence number)
3. Run `npx drizzle-kit check` to detect inconsistencies
4. If conflicts found:
   - Delete conflicting migration files and snapshots
   - Re-run `npx drizzle-kit generate` on the merged schema
   - Commit the new clean migration

### Best Practices
- Commit migration files to version control
- Never manually edit snapshot JSON files
- Run `drizzle-kit check` in CI to catch conflicts
- Use `--name` flag for descriptive migration names
- Keep schema changes small and incremental
- Use `drizzle-kit push` only for local dev, never for production
